<h3>Sources & Citations</h3>

<%= f.fields_for :citations do |cf| %>
  <div class="citation-fields">
    <!-- Choose existing Source -->
    <div>
      <%= cf.label :source_id, "Source" %>
      <%= cf.collection_select :source_id, @sources, :id, :title,
            { prompt: "Select a source…" },
            { required: true } %>
    </div>

    <!-- Or create a new Source inline -->
    <%= cf.fields_for :source do |sf| %>
      <details class="mt-2">
        <summary>Or create a new source</summary>
        <div>
          <%= sf.label :title, "Source title" %>
          <%= sf.text_field :title %>
        </div>
        <div>
          <%= sf.label :author %>
          <%= sf.text_field :author %>
        </div>
        <div>
          <%= sf.label :publisher %>
          <%= sf.text_field :publisher %>
        </div>
        <div>
          <%= sf.label :year %>
          <%= sf.text_field :year %>
        </div>
        <div>
          <%= sf.label :url %>
          <%= sf.url_field :url %>
        </div>
      </details>
    <% end %>

    <!-- Citation details -->
    <div>
      <%= cf.label :pages %>
      <%= cf.text_field :pages, placeholder: "e.g., 41–43" %>
    </div>

    <div>
      <%= cf.label :quote %>
      <%= cf.text_area :quote %>
    </div>

    <div>
      <%= cf.label :note %>
      <%= cf.text_area :note %>
    </div>

    <div>
      <%= cf.check_box :_destroy %>
      <%= cf.label :_destroy, "Remove" %>
    </div>
  </div>
<% end %>

Common gotchas (so you don’t trip):

Inline block not showing? Make sure you call ensure_nested_source_builds (or at least c.build_source) before rendering the form.

Strong params must include source_attributes: [...] or Rails will ignore the nested fields.

Validation fails with ‘Source can’t be blank’: Either the dropdown was left on the prompt and the inline block was left empty (rejected by reject_if), or you forgot the controller build_source line.
