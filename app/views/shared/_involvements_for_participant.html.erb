<%# locals: participant:, involvements: %>
<% groups = involvements.group_by(&:involvable_type).transform_values { |rows| rows.group_by(&:involvable) } %>
<% if groups.present? %>
  <h3>Involvements</h3>
  <% groups.each do |type, rec_hash| %>
    <h4 class="mt-3"><%= type.to_s.titleize %></h4>
    <ul class="list-unstyled ms-2">
      <% rec_hash.each do |rec, invs| %>
        <li class="mb-2">
          <% if rec.present? %>
            <%= link_to(rec.try(:name) || rec.try(:title) || "(unnamed)", rec) %>
          <% else %>
            (record missing)
          <% end %>
          <% invs.each do |inv| %>
            <% details = [] %>
            <% details << content_tag(:strong, inv.role) if inv.role.present? %>
            <% details << "(#{inv.year})"               if inv.year.present? %>
            <% details << content_tag(:em, inv.note)    if inv.note.present? %>
            <% if details.any? %>
              â€” <span class="text-muted"><%= safe_join(details, " ") %></span>
            <% end %>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% end %>
<% else %>
  <h3>Involvements</h3>
  <p><em>No involvements recorded.</em></p>
<% end %>
