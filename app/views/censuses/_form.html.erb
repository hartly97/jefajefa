<%= form_with model: @census, local: true do |f| %>
  <div class="row g-3">
    <div class="col-md-3"><%= f.label :country %><%= f.text_field :country, class: "form-control" %></div>
    <div class="col-md-2"><%= f.label :year %><%= f.number_field :year, class: "form-control" %></div>
    <div class="col-md-3"><%= f.label :district %><%= f.text_field :district, class: "form-control" %></div>
    <div class="col-md-3"><%= f.label :subdistrict %><%= f.text_field :subdistrict, class: "form-control" %></div>
    <div class="col-md-4"><%= f.label :place %><%= f.text_field :place, class: "form-control" %></div>
    <div class="col-md-2"><%= f.label :piece %><%= f.text_field :piece, class: "form-control" %></div>
    <div class="col-md-2"><%= f.label :folio %><%= f.text_field :folio, class: "form-control" %></div>
    <div class="col-md-2"><%= f.label :page %><%= f.text_field :page, class: "form-control" %></div>
  </div>

  <fieldset class="border rounded p-3 my-3">
    <legend class="fw-bold small">Image (External)</legend>

    <div class="mb-3">
      <%= f.label :external_image_url, "Image URL (SmugMug)" %>
      <%= f.url_field :external_image_url,
            class: "form-control",
            placeholder: "https://photos.smugmug.com/.../image.jpg" %>
      <div class="form-text">
        Paste a direct image URL (jpg/png/webp). We dont upload the file; we embed it.
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <%= f.label :external_image_caption, "Caption" %>
        <%= f.text_field :external_image_caption, class: "form-control" %>
      </div>
      <div class="col-md-6">
        <%= f.label :external_image_credit, "Credit / Attribution" %>
        <%= f.text_field :external_image_credit,
              class: "form-control",
              placeholder: " Your Name / SmugMug" %>
      </div>
    </div>

    <div id="image-url-preview" class="mt-3" style="<%= f.object.external_image_url.present? ? "" : "display:none" %>">
      <strong>Preview</strong>
      <div class="ratio ratio-16x9 border">
        <img id="image-url-preview-img"
             alt="Preview"
             src="<%= f.object.external_image_url %>"
             style="object-fit:contain; width:100%; height:100%">
      </div>
    </div>
  </fieldset>

  <h5>Citations</h5>
  <%= render "citations/sections", f: f, sources: (@sources || Source.order(:title)) %>
 
<%= render "shared/category_picker",
      record: @censuses, object_name: :censuses,
      scope: Category.censusess.order(:name), legend: "Census categories" %>


  <div class="mt-3">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", censuses_path, class: "btn btn-link" %>
  </div>
<% end %>

<script>
document.addEventListener("turbo:load", attachCensusPreview)
document.addEventListener("turbo:frame-load", attachCensusPreview)
function attachCensusPreview() {
  const input = document.querySelector('input[name="census[external_image_url]"]')
  const box   = document.getElementById('image-url-preview')
  const img   = document.getElementById('image-url-preview-img')
  if (!input || !box || !img) return
  const show = (url) => {
    url = (url || "").trim()
    if (!/^https?:\/\//.test(url)) { box.style.display = "none"; img.removeAttribute('src'); return }
    img.src = url
    box.style.display = ""
  }
  input.addEventListener('input', () => show(input.value))
  show(input.value)
}
</script>
