<div class="border p-3 mb-3 rounded citation-fields" data-citations-wrapper>
  <div class="d-flex justify-content-between align-items-center mb-2">
    <strong>Citation</strong>
    <button type="button"
            class="btn btn-sm btn-outline-danger"
            data-action="click->citations#remove">
      Remove
    </button>
  </div>

  <%= cf.check_box :_destroy, class: "d-none" %>
  <!-- ...the rest of your fields using `cf`... -->
</div>

<%# locals: cf:, sources: %>

<div class="border p-3 mb-3 rounded citation-fields"
     data-controller="source-picker"
     data-citations-wrapper
     data-citations-target="wrapper">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <strong>Citation</strong>
    <button type="button" class="btn btn-sm btn-outline-danger"
            data-action="click->citations#remove">Remove</button>
  </div>


  <div class="field mb-2">
    <%= cf.label :source_id, "Source" %>
    <%= cf.collection_select :source_id,
          (defined?(sources) && sources.present?) ? sources : Source.order(:title),
          :id, :title,
          { include_blank: "‚Äî Select a source ‚Äî" },
          { class: "form-select", data: { "source-picker-target": "select" } } %>
    <small class="text-muted">Tip: pick an existing source or add a new one below.</small>
  </div>

  <div class="mb-2">
    <label>Search all sources</label>
    <input type="text"
           class="form-control"
           placeholder="Type 2+ letters‚Ä¶"
           data-action="input->source-picker#autocomplete"
           data-source-picker-target="query">
    <ul class="list-group mt-1" data-source-picker-target="results"></ul>
  </div>

  <% recent = Source.order(updated_at: :desc).limit(10) %>
  <% if recent.any? %>
    <div class="mb-2">
      <label>Recent</label>
      <%= select_tag :recent_source_id,
            options_for_select([["‚Äî Pick recent ‚Äî",""]] + recent.map { |s| [s.title, s.id] }),
            class: "form-select",
            data: { action: "change->source-picker#pick" } %>
    </div>
  <% end %>

  <div class="mt-3">
    <button class="btn btn-sm btn-outline-secondary"
            type="button"
            data-action="click->source-picker#toggleNewForm">
      + Add a new source instead
    </button>

    <div class="mt-2" data-source-picker-target="newForm" style="display:none">
      <div class="alert alert-info py-2 px-3 mb-2">
        Leave ‚ÄúSource‚Äù above blank if you enter a new one here.
      </div>

      <%# üëá NEW source for THIS citation: use cf.fields_for :source do |sf| %>
      <%= cf.fields_for :source do |sf| %>
        <div class="row g-3">
          <div class="col-md-8">
            <%= sf.label :title %>
            <%= sf.text_field :title, class: "form-control",
                  placeholder: "Book/Newspaper/Collection title",
                  data: { action: "input->source-picker#clearSelectIfTyped" } %>
          </div>
          <div class="col-md-4">
            <%= sf.label :author %>
            <%= sf.text_field :author, class: "form-control" %>
          </div>
          <div class="col-md-3">
            <%= sf.label :publisher %>
            <%= sf.text_field :publisher, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= sf.label :year %>
            <%= sf.text_field :year, class: "form-control" %>
          </div>
          <div class="col-md-7">
            <%= sf.label :url, "URL" %>
            <%= sf.url_field :url, class: "form-control" %>
          </div>
          <div class="col-md-6">
            <%= sf.label :repository %>
            <%= sf.text_field :repository, class: "form-control" %>
          </div>
          <div class="col-md-6">
            <%= sf.label :link_url, "Repository link" %>
            <%= sf.url_field :link_url, class: "form-control" %>
          </div>
          <div class="col-12">
            <%= sf.label :details %>
            <%= sf.text_area :details, rows: 2, class: "form-control" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <%= cf.label :pages, "Page(s)" %>
      <%= cf.text_field :pages, class: "form-control", placeholder: "e.g., 12‚Äì13" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :folio %>
      <%= cf.text_field :folio, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :column %>
      <%= cf.text_field :column, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :line_number, "Line #" %>
      <%= cf.text_field :line_number, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :record_number %>
      <%= cf.text_field :record_number, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :locator, "Other locator" %>
      <%= cf.text_field :locator, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :image_url, "Image URL" %>
      <%= cf.url_field :image_url, class: "form-control" %>
    </div>
    <div class="col-md-3">
      <%= cf.label :image_frame, "Frame" %>
      <%= cf.text_field :image_frame, class: "form-control" %>
    </div>
    <div class="col-md-3">
      <%= cf.label :roll, "Roll / Piece" %>
      <%= cf.text_field :roll, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= cf.label :enumeration_district, "ED" %>
      <%= cf.text_field :enumeration_district, class: "form-control" %>
    </div>
  </div>

  <div class="mt-3">
    <%= cf.label :quote %>
    <%= cf.text_area :quote, rows: 2, class: "form-control" %>
  </div>
  <div class="mt-2">
    <%= cf.label :note %>
    <%= cf.text_area :note, rows: 2, class: "form-control" %>
  </div>

  <%= cf.check_box :_destroy, style: "display:none" %>
</div>
