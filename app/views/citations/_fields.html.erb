<%# app/views/citations/_fields.html.erb %>
<div class="border p-3 mb-3 rounded citation-fields"
     data-controller="source-picker"
     data-citations-wrapper>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <strong>Citation</strong>
    <button type="button" class="btn btn-sm btn-outline-danger" data-action="citations#remove">Remove</button>
  </div>

  <!-- Pick existing source -->
  <div class="field mb-2">
    <%= f.label :source_id, "Source" %>
    <%= f.collection_select :source_id,
          (defined?(sources) && sources.present?) ? sources : Source.order(:title),
          :id, :title,
          { include_blank: "— Select a source —" },
          { class: "form-select", data: { "source-picker-target": "select" } } %>
    <small class="text-muted">
      Tip: pass @sources to show all; or pass Source.common if you maintain a curated list.
    </small>
  </div>

  <div class="mb-2">
    <label>Search all sources</label>
    <input type="text"
           class="form-control"
           placeholder="Type 2+ letters…"
           data-action="input->source-picker#autocomplete"
           data-source-picker-target="query">
    <ul class="list-group mt-1" data-source-picker-target="results"></ul>
  </div>

  <div class="mb-2">
    <label>Recent</label>
    <%= select_tag :recent_source_id,
          options_from_collection_for_select(Source.order(updated_at: :desc).limit(10), :id, :title),
          include_blank: "— Pick recent —",
          class: "form-select",
          data: { action: "source-picker#pick" } %>
  </div>

  <!-- OR: create a new source inline -->
  <div class="mt-3">
    <button class="btn btn-sm btn-outline-secondary"
            type="button"
            data-action="click->source-picker#toggleNewForm">
      + Add a new source instead
    </button>

    <div class="mt-2" data-source-picker-target="newForm" style="display:none">
      <div class="alert alert-info py-2 px-3 mb-2">
        Leave “Source” above blank if you enter a new one here.
      </div>

      <%= f.fields_for :source do |sf| %>
        <div class="row g-3">
        <%= sf.hidden_field :id %>
          <div class="col-md-8">
            <%= sf.label :title %>
            <%= sf.text_field :title, class: "form-control",
                  placeholder: "Book/Newspaper/Collection title",
                  data: { action: "input->source-picker#clearSelectIfTyped" } %>
          </div>
          <div class="col-md-4">
            <%= sf.label :author %>
            <%= sf.text_field :author, class: "form-control" %>
          </div>

          <div class="col-md-3">
            <%= sf.label :publisher %>
            <%= sf.text_field :publisher, class: "form-control" %>
          </div>
          <div class="col-md-2">
            <%= sf.label :year %>
            <%= sf.text_field :year, class: "form-control" %>
          </div>
          <div class="col-md-7">
            <%= sf.label :url, "URL" %>
            <%= sf.url_field :url, class: "form-control" %>
          </div>

          <div class="col-md-6">
            <%= sf.label :repository %>
            <%= sf.text_field :repository, class: "form-control" %>
          </div>
          <div class="col-md-6">
            <%= sf.label :link_url, "Repository link" %>
            <%= sf.url_field :link_url, class: "form-control" %>
          </div>

          <div class="col-12">
            <%= sf.label :details %>
            <%= sf.text_area :details, rows: 2, class: "form-control" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Locator fields -->
  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <%= f.label :page, "Page" %>
      <%= f.text_field :page, class: "form-control", placeholder: "e.g., 12–13" %>
    </div>
    <div class="col-md-6">
      <%= f.label :folio %>
      <%= f.text_field :folio, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :column %>
      <%= f.text_field :column, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :line_number, "Line #" %>
      <%= f.text_field :line_number, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :record_number %>
      <%= f.text_field :record_number, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :locator, "Other locator" %>
      <%= f.text_field :locator, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :image_url, "Image URL" %>
      <%= f.url_field :image_url, class: "form-control" %>
    </div>
    <div class="col-md-3">
      <%= f.label :image_frame, "Frame" %>
      <%= f.text_field :image_frame, class: "form-control" %>
    </div>
    <div class="col-md-3">
      <%= f.label :roll, "Roll / Piece" %>
      <%= f.text_field :roll, class: "form-control" %>
    </div>
    <div class="col-md-6">
      <%= f.label :enumeration_district, "ED" %>
      <%= f.text_field :enumeration_district, class: "form-control" %>
    </div>
  </div>

  <div class="mt-3">
    <%= f.label :quote %>
    <%= f.text_area :quote, rows: 2, class: "form-control" %>
  </div>
  <div class="mt-2">
    <%= f.label :note %>
    <%= f.text_area :note, rows: 2, class: "form-control" %>
  </div>

  <%= f.check_box :_destroy, style: "display:none" %>
</div>